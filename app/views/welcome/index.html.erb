<div class="container">

    <div class="top"> 


    </div>

    <h1>Encontre ajuda perto de você!</h1>

    <%= form_with(url: "/",action: "geocode",method: "post") do |form| %>
        <p>
            <%= form.label :endereco_atual %>
            <%= form.text_field :endereco_atual %>
        </p>
        <p>
        <%#= form.submit "limpar", :type => "reset" %>
        <%= form.submit :Salvar , :name=>"salvar"%> 

        
        </p>
    <% end %>

    <p id="localizacaoAtual" name="localizacaoAtual"> </p>

    <table>
    <% @clinicas.each do |c| %>
        <tr class="container">
            <td class="name"><%= c.name %></td>
            <td class="address"><%= c.address %></td>
        </tr>
        <br>
    <% end %>
    </table>

    <div id="map" data-test-env="<%= Rails.env.test? %>"></div>

    <script>
        // Initialize and add the map
        function initMap() {
        
        var x = localStorage.getItem('coordenadaAtual')                         
        var coordenadaAtual= x ? JSON.parse(x) : null

        var latLng = null
        if (coordenadaAtual){
            latLng= new google.maps.LatLng(coordenadaAtual[0],coordenadaAtual[1])
        }   
        var each = {lat: -23.4823919,lng:-46.5004498}

        window.map = new google.maps.Map(
           document.getElementById('map'), {zoom: 18, center: latLng ? latLng :each});  
        var mapa = document.getElementById('map')
        var opt = !(mapa.getAttribute('data-test-env')) 
        //a propriedade optmized eh setada como false para ambiente de testes
        //cria o marker como elemento unico na DOM        

        <% @clinicas.each do |c| %>
           var lat = <%= c.latitude %>;
           var longitude = <%= c.longitude %>;
           var marker = new google.maps.Marker({
               position: {lat:  <%= c.latitude %>, lng:  <%= c.longitude %>},
               map: map,
               optimized: !opt
               });

       <% end %>


      
        }
        var coordAtual = localStorage.getItem('coordenadaAtual')
        if (coordAtual){
            document.getElementById("localizacaoAtual").innerHTML = "Localizacao Salva"
        } else{
            document.getElementById("localizacaoAtual").innerHTML = "Localizacao Não Salva"
        }
                
    </script>



    
    <script defer
        src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['MAPS_API_KEY']%>&callback=initMap">
    </script>



</div>
